<style>
  textarea {
    min-width: 60px;
    min-height: 40px;
    overflow-y: visible;
    padding: 0;
    margin: 0;
    outline: none;
    overflow: auto;
  }

  /*th {min-width: 100px;}*/
  tr:first-child td {
    font-size: 12px;
    background: #f2f2f2;
    vertical-align: top;
  }

  table tr td {
    padding-left: 2px;
    padding-right: 2px;
    margin: 0;
    border-collapse: collapse;
    border: 1px solid gray;
    min-width: 20px;
    max-width: 100px;
  }
</style>
<table id="EDUTBL" class="" style="width:150%">
  <tr>
    <td class="small no-print" style="width:10px;padding:0;margin: 0;">-</td>
    <td class="small no-print" style="width: 10px;">序號</td>
    <!-- td id="MA_H">組</td -->
    <!-- td id="MA_H">校內編號</td -->
    <td id="MB_H" style="width:80px;max-width:80px;min-width: 80px;">產品編號*</td>
    <td id="MC_H" style="min-width: 100px;">產品名稱*</td>
    <td id="MD_H">model</td>
    <td id="ME_H">SN/PN</td>
    <td id="MF_H">數量</td>
    <td id="MG_H">單價</td>
    <td id="MI_H">購入金額</td>
    <td id="MJ_H">攤折淨值</td>
    <td id="MK_H">年限*</td>
    <td id="ML_H">資助額</td>
    <td id="MM_H">資助單位/個人</td>
    <td id="MN_H">資助標籤</td>
    <td id="MO_H">位置</td>
    <td id="MP_H">保管人</td>
    <td id="MQ_H">備註</td>
    <td id="MR_H" class="no-print">登錄日期</td>
    {% if netdev==1 %}
    <td id="MS_H">hostname  </td>
    <td id="MT_H">wifi_mac  </td>
    <td id="MU_H">lan_mac 	</td>
    <td id="MV_H">Warr_id	</td>
    <td id="MW_H">IYR_Bat	</td>
    <td id="M0_H">cpu</td>
    <td id="M1_H">ram</td>
    <td id="M2_H">disk</td>
    <td id="M5_H">保養</td>
    {% endif %}
    <!--td id="M3_H">ict_no</td-->
    <td id="M4_H">供應商</td>
    <td id="MX_H" class="no-print">分類*</td>
    <td id="MY_H" class="no-print">年度*</td>
    <td id="MZ_H" class="no-print">專案編號</td>
  </tr>
  {% for item_ in items %}
  <tr>
    <td class="small no-print" style="width:10px;padding:0;margin: 0;">{{loop.index}}</td>
    <td class="small no-print" style="width: 10px;"><a href="/EsAsset/{{acc_id}}/item/{{item_.id}}">{{item_.id}}</a></td>
    <!-- td class="M" id="MA_gno_{{item_.id}}">{{ '%02d' | format(item_.gno) if item_.gno is not none}}</td-->
    <!--td class="M" id="MA_itemno_{{item_.id}}">{{item_.itemno if item_.itemno is not none}}</td-->
    <td class="M" id="MB_itemcatno_{{item_.id}}">{{ '%011d' |
      format(item_.itemcatno) if item_.itemcatno is not none }}</td>
    <td class="M" id="MC_name_{{item_.id}}">{{item_.name}}</td>
    <td class="M" id="MD_model_{{item_.id}}">{{item_.model}}</td>
    <td class="M" style="max-width: 200px;" id="ME_sn_{{item_.id}}">{{item_.sn}}</td>
    <td class="M" id="MF_quantity_{{item_.id}}">{{item_.quantity if item_.quantity is not none}}</td>
    <td class="M" id="MG_price_{{item_.id}}">{{item_.price if item_.price is not none}}</td>
    <td class="M" id="MI_p-amount_{{item_.id}}">{{item_.p_amount if item_.p_amount is not none}}</td>
    <td class="M" id="MJ_amount_{{item_.id}}">{{item_.amount if item_.amount is not none}}</td>
    <td class="M" id="MK_depr-year_{{item_.id}}">{{item_.depr_year}}</td>
    <td class="M" id="ML_fund-amount_{{item_.id}}">{{item_.fund_amount if item_.fund_amount is not none}}</td>
    <td class="M" id="MM_fund-name_{{item_.id}}">{{item_.fund_name if item_.fund_name is not none}}</td>
    <td class="M" id="MN_fund-lebal_{{item_.id}}">{{item_.fund_lebal if item_.fund_lebal is not none}}</td>
    <td class="M" id="MO_place_{{item_.id}}">{{item_.place if item_.place is not none}}</td>
    <td class="M" id="MP_keeper_{{item_.id}}">{{item_.keeper if item_.keeper is not none}}</td>
    <td class="M" id="MQ_note1_{{item_.id}}">{{item_.note1 if item_.note1 is not none}}</td>
    <td class="M no-print" style="max-width: 80px;" id="MR_regSDate_{{item_.id}}">
      {{item_.regSDate.strftime('%Y-%m-%d')}}</td>
    {% if netdev==1 %}
      <td class="M" id="MS_hostname_{{item_.id}}">{{item_.hostname}}</td>
      <td class="M" id="MT_wifi-mac_{{item_.id}}">{{item_.wifi_mac}}</td>
      <td class="M" id="MU_lan-mac_{{item_.id}}">{{item_.lan_mac}}</td>
      <td class="M" id="MV_warr-id_{{item_.id}}">{{item_.warr_id}}	</td>
      <td class="M" id="MW_iyr-bat_{{item_.id}}">{{item_.iyr_bat}}	</td>
      <td class="M" id="M0_cpu_{{item_.id}}">{{item_.cpu}}</td>
      <td class="M" id="M1_ram_{{item_.id}}">{{item_.ram}}</td>
      <td class="M" id="M2_disk_{{item_.id}}">{{item_.disk}}</td>
      <td class="M" id="M5_warr-period_{{item_.id}}">{{item_.warr_period if item_.warr_period is not none}}</td>
    {% endif %} 
      <!--td class="M" id="M3_ict_{{item_.id}}">{{item_.ict if item_.ict is not none}}</td-->
      <td class="M" id="M4_supplier_{{item_.id}}">{{item_.supplier if item_.supplier is not none}}</td>
    <td class="M no-print" id="MX_cate_{{item_.id}}">{{item_.cate}}</td>
    <td class="M no-print" id="MY_sess_{{item_.id}}">{{item_.sess}}</td>

    {% if session.profile and session.profile.user=='admin' and True %}
    <td class="M no-print" id="MZ_acc-acno_{{item_.id}}">{{item_.acc_acno}}</td>
    {% else %}
    <td class="no-print">{{item_.acc_acno}}</td>
    {% endif %}
  </tr>
  {% else %}
  <tr>
    <td>No item found</td>
  </tr>
  {% endfor %}
</table>
<div id="es_msgbox">
  <div id="es_msgbox_txt"></div>
</div>
<script>
  var es_msgbox = $("#es_msgbox").dialog({
    autoOpen: false, height: 700, width: 500, modal: true,
    open: function (event, ui) { $("#es_msgbox_txt").html("") },
    buttons: {
      Cancel: function () { es_msgbox.dialog("close"); }
    }
  });
  function status_place_chg() {
    closeedit();
    es_msgbox.dialog("open");
    var table = document.getElementById("EDUTBL");
    let json = {}
    let curr_itemno = null;
    for (var i = 0, row; row = table.rows[i]; i++) {
      if (row.cells[0].innerHTML == "-") continue;
      for (var j = 0, col; col = row.cells[j]; j++) {
        if (col.id && col.id.indexOf("itemno") > -1 && col.innerHTML != "") {
          curr_itemno = col.innerHTML;
          if (curr_itemno in json) { } else { json[curr_itemno] = { "itemno": curr_itemno }; }
        }
        if (col.id && col.id.indexOf("place") > -1) { json[curr_itemno]["place"] = col.innerHTML; }
        if (col.id && col.id.indexOf("keeper") > -1) { json[curr_itemno]["keeper"] = col.innerHTML; }
      }
    }
    for (let itemno_ in json) {
      if (json[itemno_]["place"] == "" && json[itemno_]["keeper"] == "") { }
      else {
        $.ajax({
          url: `/EsAsset/api/JSON/getItemnoMoveLog_by_itemno/${itemno_}`,
          method: "GET",
          contentType: "application/json",
        }).done(function (data) {
          if (data.length > 0 && json[itemno_]["place"] == data[0]["place"] && json[itemno_]["keeper"] == data[0]["keeper"]) {
            let temp_ = $("#es_msgbox_txt").html()
            $("#es_msgbox_txt").html(temp_ + "<br>" + JSON.stringify(data))
          } else {
            $.ajax({
              method: "POST",
              url: `/EsAsset/api/JSON/pushItemnoMoveLog`,
              data: JSON.stringify(json[itemno_]),
              contentType: "application/json"
            }).done(function (data_) {
              let temp_ = $("#es_msgbox_txt").html()
              $("#es_msgbox_txt").html(temp_ + "<br>新增轉移記錄:<br>" + JSON.stringify(data_))
            });
          }
        });
      }
    }
  }
  function depr_rate(acno, depr_year) {
    //let res = /FA[\d][\d][\d][\d]/.exec(acno)
    //if (res == null) { return 0; }
    //if (res[0] == "FA0000") { return 0; }
    //let y = res[0].substring(2, 2)
    y = acno.substring(0, 2)
    if (y.startsWith('9')) { y = `19${y}` } else { y = `20${y}` }
    console.log(y)
    const d = new Date();
    let year = d.getFullYear();
    let month = d.getMonth() + 1;
    let dy = year - Number(y)
    if (dy > 0) dy = dy - (month < 8 ? 1 : 0)
    if (dy == 0) return 1;
    if (dy > 50) return 0;
    if (dy > 0 && dy < 51 && depr_year > 0 && depr_year < 51 && depr_year > dy) return (depr_year - dy) / depr_year;
    return 0;
  }
  function calcTotalbtn() {
    closeedit();
    var table = document.getElementById("EDUTBL");
    let total_quantity = 0;
    let total_pamount = 0;
    let total_amount = 0;
    let total_fund_amount = 0;
    for (var i = 0, row; row = table.rows[i]; i++) {
      if (row.cells[0].innerHTML == "-") continue;
      let price = 0;
      let quantity = 0;
      let amount = 0;
      let pamount = 0;
      let pamount_cell = null;
      let amount_cell = null;
      let depr_year = 0;
      let itemcatno = "" //row.cells[row.cells.length - 1].innerHTML;
      for (var j = 0, col; col = row.cells[j]; j++) {
        if (col.id && col.id.indexOf("itemcatno") > -1) itemcatno = col.innerHTML
        if (col.id && col.id.indexOf("price") > -1) price = Number(col.innerHTML)
        if (col.id && col.id.indexOf("quantity") > -1) quantity = Number(col.innerHTML)
        if (col.id && col.id.indexOf("p-amount") > -1) { pamount_cell = col; pamount = Number(pamount_cell.innerHTML) }
        if (col.id && col.id.indexOf("amount") > -1) { amount_cell = col; }
        if (col.id && col.id.indexOf("depr-year") > -1) {
          console.log(quantity, price, pamount)
          depr_year = Number(col.innerHTML)
          pamount = (price == 0 || quantity == 0) ? pamount : price * quantity
          if (price == 0 || quantity == 0) {

          } else {
            pamount_cell.innerHTML = pamount.toFixed(2)
          }
          amount = pamount * depr_rate(itemcatno, depr_year)
          amount_cell.innerHTML = amount.toFixed(2)
          total_pamount += pamount
          total_amount += amount
          total_quantity += quantity

        }
        if (col.id && col.id.indexOf("fund-amount") > -1) {
          total_fund_amount += Number(col.innerHTML)
          console.log(total_fund_amount)
        }
        if (col.id && col.id.indexOf("_cate_") > -1) {
          if (col.innerHTML) {
            col.innerHTML = itemcatno.substring(0, 4)
          }
          break;
        }
      }
    }
    let totalrow = table.rows[table.rows.length - 1];
    if (totalrow.cells[0].innerHTML != "-") {
      totalrow = table.insertRow();
      var cell1 = totalrow.insertCell(0);
      var cell2 = totalrow.insertCell();
      var cell3 = totalrow.insertCell();
      var cell4 = totalrow.insertCell();
      var cell5 = totalrow.insertCell();
      var cell6 = totalrow.insertCell();
      var cell7 = totalrow.insertCell();
      var cell8 = totalrow.insertCell();
      var cell9 = totalrow.insertCell();
      var cell10 = totalrow.insertCell();
      var cell11 = totalrow.insertCell();
      var cell12 = totalrow.insertCell();
      var cell13 = totalrow.insertCell()
      cell1.classList.add("no-print");
      cell2.classList.add("no-print");
      cell7.style.textAlign = "right";
      cell8.style.textAlign = "right";
      cell10.style.textAlign = "right";
      cell11.style.textAlign = "right";
      cell13.style.textAlign = "right";
      cell1.innerHTML = "-";
      cell7.innerHTML = "小計";
      cell8.innerHTML = total_quantity;
      cell10.innerHTML = total_pamount.toFixed(2);
      cell11.innerHTML = total_amount.toFixed(2);
      cell13.innerHTML = total_fund_amount.toFixed(2);
    } else {
      totalrow.cells[7].innerHTML = total_quantity;
      totalrow.cells[9].innerHTML = total_pamount.toFixed(2);
      totalrow.cells[10].innerHTML = total_amount.toFixed(2);
      totalrow.cells[12].innerHTML = total_fund_amount.toFixed(2);
    }
    if (PostUrl) {
      let isExecuted = confirm("是否儲存結果?");
      if (isExecuted) {
        saveTotal(PostUrl)
      }
    }
  }

  class ItemtableFrmMessageBox {
    msg(x) {
      let temp_ = $("#es_msgbox_txt").html();
      $("#es_msgbox_txt").html(temp_ + "<br>攤折及淨值 update:<br>" + x);
    }
  }

  function post_total_url(PostUrl, rowid, jsondata, frmMessageBox) {
    return new Promise((resolve, reject) => {
      $.ajax({
        method: "POST",
        url: PostUrl + `/${rowid}`,
        data: JSON.stringify(jsondata),
        contentType: "application/json",
        timeout: 4000,
        statusCode: {
          500: function () {
            resolve(rowid);
          }
        }
      }).done(function (data) {
        frmMessageBox.msg(JSON.stringify(data))
        resolve(0)
      }).fail(function (jqXHR, textStatus, errorThrown) {
        resolve(rowid);
      });
    })
  }

  async function saveTotal(PostUrl) {
    closeedit();
    es_msgbox.dialog("open");
    let frmMsg_ = new ItemtableFrmMessageBox()
    var table = document.getElementById("EDUTBL");
    let json = {}
    let curr_itemno = null;
    for (var i = 0, row; row = table.rows[i]; i++) {
      if (row.cells[0].innerHTML == "-") continue;
      for (var j = 0, col; col = row.cells[j]; j++) {
        for (let fieldname of ["price","quantity","p-amount", "amount", "cate"]) {
          if (col.id && col.id.indexOf(`_${fieldname}_`) > -1) {
            let elarr = col.id.split("_")
            curr_itemno = elarr[2];
            if (curr_itemno in json) { } else { json[curr_itemno] = {}; }
            json[curr_itemno][fieldname.replace("-", "_")] = col.innerHTML
          }
        }
      }
    }
    if (PostUrl.indexOf("updateSet") > -1) {
      let keys_ = Object.keys(json)
      let json_ = {}
      for (let i = 0; i < keys_.length; i++) {
        json_[keys_[i]] = json[keys_[i]]
        if ((i + 1) % 200 == 0) {
          let stat_ = await post_total_url(PostUrl, 0, json_, frmMsg_)
          json_ = {}
        }
      }
      if (json_ == {}) { }
      else {
        let stat_ = await post_total_url(PostUrl, 0, json_, frmMsg_)
      }
    } else {
      let error_set = []
      for (let itemno_ in json) {
        console.log(json[itemno_])
        let stat_ = await post_total_url(PostUrl, itemno_, json[itemno_], frmMsg_)
        if (stat_ != 0) error_set.push(stat_)
      }
      for (let itemno_ of error_set) {
        let stat_ = await post_total_url(PostUrl, itemno_, json[itemno_], frmMsg_)
        if (stat_ != 0) alert(stat_)
      }
    }
  }
  // '%03d' | format(my_bandwitdth|int)
</script>